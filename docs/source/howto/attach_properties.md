# Custom Properties During KMC Runs

`KMC` supports attachable property functions with an API similar to ASE-style callbacks.

## Quick start

```python
from kmcpy.simulator.kmc import KMC

kmc = KMC.from_config(config)

def calc_occupation(state, step, sim_time):
    occupied = sum(1 for occ in state.occupations if occ > 0)
    return occupied / len(state.occupations)

# Run every 100 production events.
kmc.attach(calc_occupation, interval=100, name="calc_occupation")
tracker = kmc.run(config)
```

## Callback signature

Each callback must use this signature:

```python
def callback(state, step, sim_time):
    ...
```

- `state`: `SimulationState` object (current mutable simulation state)
- `step`: production event step index
- `sim_time`: current simulation time

## Sampling frequency

Set a global property cadence (used when callback-level cadence is omitted):

```python
kmc.set_property_frequency(interval=200)
```

Callback-level overrides are also supported:

```python
kmc.attach(my_property, interval=50)
kmc.attach(other_property, time_interval=1e-8)
```

## Built-in properties

Built-ins are enabled by default and written to `results_<label>.csv.gz`:

- `msd`
- `jump_diffusivity`
- `tracer_diffusivity`
- `conductivity`
- `havens_ratio`
- `correlation_factor`

Disable/enable built-ins individually:

```python
kmc.set_property_enabled("conductivity", False)
kmc.set_property_enabled("conductivity", True)
```

Disabled built-ins remain in the legacy CSV schema with `NaN` values.

## Error handling

By default, callback errors stop the simulation.

You can provide an error handler per callback:

```python
def on_error(exc, state, step, sim_time):
    print(f"callback failed at step={step}: {exc}")
    return True  # continue simulation

kmc.attach(calc_occupation, interval=100, on_error=on_error)
```

## Output files

- Built-in properties: `results_<label>.csv.gz` (legacy format)
- Attached callback records: `properties_<label>.json.gz`

Retrieve custom records from the returned tracker object:

```python
records = tracker.get_property_records("calc_occupation")
```

## API reference

API docs are generated by Sphinx from docstrings:

- `kmcpy.simulator.kmc`
- `kmcpy.simulator.tracker`
